import{SvelteComponent as A,append as y,attr as V,check_outros as H,create_component as q,destroy_component as C,destroy_each as z,detach as E,element as $,empty as D,group_outros as I,init as J,insert as S,listen as K,mount_component as N,safe_not_equal as Q,space as j,text as U,transition_in as v,transition_out as F}from"../../web_modules/svelte/internal.js";import{onMount as X}from"../../web_modules/svelte.js";import{dispatchSingle as M}from"../event/EventBus.js";import{randomString as w}from"../util/Generate.js";import{subscribeFieldChange as Z}from"../event/FieldEvent.js";import P from"../store/FormStore.js";import{firstNotEmpty as x}from"../util/Format.js";import{fastClone as ee,isEmptyOrNull as le}from"../util/Compare.js";import L from"../features/form/edit/ConfigField.js";import ie from"./Button.js";function O(e,i,o){const l=e.slice();return l[12]=i[o],l[14]=o,l}function W(e){let i,o;return i=new L({props:{config:{search:!0},field:{id:w(),label:"Select Your Condition",value:{type:"local",value:e[0].logic?.rules?.[e[14]]?.condition},type:"combobox",required:!0,configFieldTarget:`logic.rules[${e[14]}].condition`,configTarget:e[0].id,options:{type:"local",value:e[6](e[14])}}}}),{c(){q(i.$$.fragment)},m(l,t){N(i,l,t),o=!0},p(l,t){const s={};t&1&&(s.field={id:w(),label:"Select Your Condition",value:{type:"local",value:l[0].logic?.rules?.[l[14]]?.condition},type:"combobox",required:!0,configFieldTarget:`logic.rules[${l[14]}].condition`,configTarget:l[0].id,options:{type:"local",value:l[6](l[14])}}),i.$set(s)},i(l){if(o)return;v(i.$$.fragment,l),o=!0},o(l){F(i.$$.fragment,l),o=!1},d(l){C(i,l)}}}function Y(e){let i,o,l,t;const s=[te,oe],m=[];function h(r,b){return r[2][r[14]].valueType==="text"?0:r[2][r[14]].valueType==="combobox"?1:-1}return~(i=h(e,-1))&&(o=m[i]=s[i](e)),{c(){o&&o.c(),l=D()},m(r,b){~i&&m[i].m(r,b),S(r,l,b),t=!0},p(r,b){let d=i;i=h(r,b),i===d?~i&&m[i].p(r,b):(o&&(I(),F(m[d],1,1,()=>{m[d]=null}),H()),~i?(o=m[i],o||(o=m[i]=s[i](r),o.c()),v(o,1),o.m(l.parentNode,l)):o=null)},i(r){if(t)return;v(o),t=!0},o(r){F(o),t=!1},d(r){~i&&m[i].d(r),r&&E(l)}}}function oe(e){let i,o;return i=new L({props:{field:{id:w(),helperText:e[2][e[14]].helperText,placeholder:e[2][e[14]].placeholder,label:"Provide Value For Conditional",value:{type:"local",value:e[0].logic?.rules?.[e[14]]?.value},type:"combobox",required:!0,configFieldTarget:`logic.rules[${e[14]}].value`,configTarget:e[0].id,options:{type:"local",value:e[2][e[14]].options}}}}),{c(){q(i.$$.fragment)},m(l,t){N(i,l,t),o=!0},p(l,t){const s={};t&5&&(s.field={id:w(),helperText:l[2][l[14]].helperText,placeholder:l[2][l[14]].placeholder,label:"Provide Value For Conditional",value:{type:"local",value:l[0].logic?.rules?.[l[14]]?.value},type:"combobox",required:!0,configFieldTarget:`logic.rules[${l[14]}].value`,configTarget:l[0].id,options:{type:"local",value:l[2][l[14]].options}}),i.$set(s)},i(l){if(o)return;v(i.$$.fragment,l),o=!0},o(l){F(i.$$.fragment,l),o=!1},d(l){C(i,l)}}}function te(e){let i,o;return i=new L({props:{field:{id:w(),helperText:e[2][e[14]].helperText,placeholder:e[2][e[14]].placeholder,label:"Provide Value For Conditional",value:{type:"local",value:e[0].logic?.rules?.[e[14]]?.value},type:"string",required:!0,configFieldTarget:`logic.rules[${e[14]}].value`,configTarget:e[0].id}}}),{c(){q(i.$$.fragment)},m(l,t){N(i,l,t),o=!0},p(l,t){const s={};t&5&&(s.field={id:w(),helperText:l[2][l[14]].helperText,placeholder:l[2][l[14]].placeholder,label:"Provide Value For Conditional",value:{type:"local",value:l[0].logic?.rules?.[l[14]]?.value},type:"string",required:!0,configFieldTarget:`logic.rules[${l[14]}].value`,configTarget:l[0].id}),i.$set(s)},i(l){if(o)return;v(i.$$.fragment,l),o=!0},o(l){F(i.$$.fragment,l),o=!1},d(l){C(i,l)}}}function G(e){let i,o,l,t,s,m,h,r,b,d,n,p,_,g,a;function c(...T){return e[8](e[14],...T)}r=new L({props:{config:{search:!0},field:{id:w(),loadTransformer:e[7],helperText:"Select which field the conditional should be ran against.",label:"Select Field",value:{type:"local",value:e[0].logic?.rules?.[e[14]]?.field},type:"combobox",required:!0,configFieldTarget:`logic.rules[${e[14]}].field`,configTarget:e[0].id,options:{type:"local",value:e[3]}}}});let f=e[0].logic?.rules?.[e[14]]?.field&&W(e),u=e[0].logic?.rules?.[e[14]]?.condition&&e[2][e[14]]?.showValue&&Y(e);return{c(){i=$("div"),o=$("div"),o.innerHTML='<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>',l=j(),t=$("div"),s=$("div"),m=$("div"),h=$("div"),q(r.$$.fragment),b=j(),d=$("div"),f&&f.c(),n=j(),p=$("div"),u&&u.c(),V(o,"class","absolute top-2 right-2"),V(t,"class","sm:p-2"),V(i,"class","bg-gray-100 overflow-visible mt-3 relative rounded-md")},m(T,k){S(T,i,k),y(i,o),y(i,l),y(i,t),y(t,s),y(s,m),y(m,h),N(r,h,null),y(s,b),y(s,d),f&&f.m(d,null),y(s,n),y(s,p),u&&u.m(p,null),_=!0,g||(a=K(o,"click",c),g=!0)},p(T,k){e=T;const B={};k&1&&(B.field={id:w(),loadTransformer:e[7],helperText:"Select which field the conditional should be ran against.",label:"Select Field",value:{type:"local",value:e[0].logic?.rules?.[e[14]]?.field},type:"combobox",required:!0,configFieldTarget:`logic.rules[${e[14]}].field`,configTarget:e[0].id,options:{type:"local",value:e[3]}}),r.$set(B),e[0].logic?.rules?.[e[14]]?.field?f?(f.p(e,k),k&1&&v(f,1)):(f=W(e),f.c(),v(f,1),f.m(d,null)):f&&(I(),F(f,1,1,()=>{f=null}),H()),e[0].logic?.rules?.[e[14]]?.condition&&e[2][e[14]]?.showValue?u?(u.p(e,k),k&5&&v(u,1)):(u=Y(e),u.c(),v(u,1),u.m(p,null)):u&&(I(),F(u,1,1,()=>{u=null}),H())},i(T){if(_)return;v(r.$$.fragment,T),v(f),v(u),_=!0},o(T){F(r.$$.fragment,T),F(f),F(u),_=!1},d(T){T&&E(i),C(r),f&&f.d(),u&&u.d(),g=!1,a()}}}function R(e){let i,o=(e[1]??"")+"";return{c(){i=$("div"),V(i,"class","helper-text")},m(l,t){S(l,i,t),i.innerHTML=o},p(l,t){t&2&&o!==(o=(l[1]??"")+"")&&(i.innerHTML=o)},d(l){l&&E(i)}}}function re(e){let i;return{c(){i=U("Add New Rule")},m(o,l){S(o,i,l)},d(o){o&&E(i)}}}function ne(e){let i,o,l,t,s,m,h=e[0].logic?.rules??[],r=[];for(let n=0;n<h.length;n+=1)r[n]=G(O(e,h,n));const b=n=>F(r[n],1,1,()=>{r[n]=null});let d=e[1]&&R(e);return s=new ie({props:{type:"primary",onClick:e[5],$$slots:{default:[re]},$$scope:{ctx:e}}}),{c(){i=$("div");for(let n=0;n<r.length;n+=1)r[n].c();o=j(),d&&d.c(),l=j(),t=$("div"),q(s.$$.fragment),V(t,"class","ml-1 mt-4")},m(n,p){S(n,i,p);for(let _=0;_<r.length;_+=1)r[_].m(i,null);y(i,o),d&&d.m(i,null),y(i,l),y(i,t),N(s,t,null),m=!0},p(n,[p]){if(p&221){h=n[0].logic?.rules??[];let g;for(g=0;g<h.length;g+=1){const a=O(n,h,g);r[g]?(r[g].p(a,p),v(r[g],1)):(r[g]=G(a),r[g].c(),v(r[g],1),r[g].m(i,o))}for(I(),g=h.length;g<r.length;g+=1)b(g);H()}n[1]?d?d.p(n,p):(d=R(n),d.c(),d.m(i,l)):d&&(d.d(1),d=null);const _={};p&32768&&(_.$$scope={dirty:p,ctx:n}),s.$set(_)},i(n){if(m)return;for(let p=0;p<h.length;p+=1)v(r[p]);v(s.$$.fragment,n),m=!0},o(n){r=r.filter(Boolean);for(let p=0;p<r.length;p+=1)F(r[p]);F(s.$$.fragment,n),m=!1},d(n){n&&E(i),z(r,n),d&&d.d(),C(s)}}}function ae(e,i,o){let{helperText:l=""}=i,{field:t}=i,s=[];Z(X,(a,c)=>{if(c.field==="value")return;t.id===a.id&&(o(0,t=a),t.logic?.action&&le(t.logic?.rules)&&r(),t.logic?.rules&&t.logic.rules.forEach((f,u)=>{o(2,s[u]=d(u),s)}))});function m(){let a=M("get_form_fields",{});return a=a.filter(c=>c.id!==t.id&&c.type!=="spacer"),a}function h(a){const c=ee(t.logic.rules);c.splice(a,1),o(0,t.logic.rules=c,t),P.set(t)}function r(){t.logic?.rules||(o(0,t.logic=t.logic??{rules:[],action:""},t),o(0,t.logic.rules=[],t)),o(0,t.logic.rules=t.logic.rules.concat([{field:"",value:"",condition:""}]),t),P.set(t)}function b(a){const c=t.logic?.rules?.[a]?.condition??"",f=["hasValue","isTrue","isFalse","notHaveValue"];return!f.includes(c)}function d(a){const c=t.logic?.rules?.[a]?.condition,f=p(a).find(u=>u.value===c);return f?{valueType:f.valueInput??"text",showValue:b(a),options:()=>n(a),helperText:f.helper??"",placeholder:f.placeholder??""}:{valueType:"text",showValue:!1,options:()=>Promise.resolve([]),helperText:"",placeholder:""}}function n(a){const c=t.logic?.rules?.[a]?.field;return c?M("combobox_get_options",{id:c}):Promise.resolve([])}function p(a){const c=t.logic?.rules?.[a]?.field;if(!c)return[];const f=m(),u=f.find(T=>T.id===c);return u?u.type==="string"?[{label:"Contains",value:"contains"},{label:"Starts With",value:"startsWith"},{label:"Ends With",value:"endsWith"},{label:"Equals",value:"eq"},{label:"Has Value",value:"hasValue"}]:u.type==="combobox"?[{label:"Equals",value:"eq",valueInput:"combobox",options:n},{label:"Not Equals",value:"notEq",valueInput:"combobox",options:n},{label:"Has Selected Option",value:"hasValue"}]:u.type==="switch"?[{label:"Is Toggled",value:"isTrue"},{label:"Is Not Toggled",value:"isFalse"}]:u.type==="file"?[{label:"Has Chosen File",value:"hasValue"},{label:"Has Not Chosen File",value:"notHaveValue"},{label:"Is File Extension",value:"isFileExtension",helper:"You can include multiple extensions by seperating with a comma.",placeholder:"pdf, txt, png"},{label:"Is Not File Extension",helper:"You can include multiple extensions by seperating with a comma.",value:"isNotFileExtension",placeholder:"pdf, txt, png"}]:u.type==="number"?[{label:"Greater Than",value:"gt"},{label:"Less Than",value:"lt"},{label:"Less Than or Equal To",value:"lte"},{label:"Greater Than or Equal To",value:"gte"},{label:"Equal To",value:"eq"},{label:"Has Value",value:"hasValue"}]:[]:[]}function _(a){return a.map(c=>({label:`${x(c.label,c.name)} - ${c.type}`,value:c.id}))}const g=a=>h(a);return e.$$set=a=>{"helperText"in a&&o(1,l=a.helperText),"field"in a&&o(0,t=a.field)},[t,l,s,m,h,r,p,_,g]}class se extends A{constructor(e){super();J(this,e,ae,ne,Q,{helperText:1,field:0})}}export default se;

import{SvelteComponent as Q,append as k,attr as B,check_outros as F,create_component as R,destroy_component as T,destroy_each as V,detach as I,element as N,group_outros as G,init as W,insert as U,mount_component as q,noop as S,safe_not_equal as X,set_data as Y,set_style as D,space as M,text as P,transition_in as b,transition_out as C}from"../../../../web_modules/svelte/internal.js";import{onMount as Z}from"../../../../web_modules/svelte.js";import E from"./Field.js";import x from"../../../components/Repeater.js";import{getUrlParameter as ee}from"../../../util/Http.js";import te from"../../../components/DropdownButton.js";import ne from"./OptionSetsList.js";import{dispatch as H}from"../../../event/EventBus.js";import{isString as $}from"../../../guards/Guard.js";import{getApi as oe,postApi as z,putApi as le}from"../../../services/ApiService.js";function J(e,t,n){const o=e.slice();return o[15]=t[n],o[16]=t,o[17]=n,o}function re(e){let t;return{c(){t=N("div"),t.innerHTML='<div class="spinner-border text-secondary" role="status"><span class="sr-only">Loading...</span></div>',D(t,"text-align","center"),D(t,"padding-top","1em"),D(t,"padding-bottom","1em")},m(n,o){U(n,t,o)},d(n){n&&I(t)}}}function ae(e){return{c:S,m:S,d:S}}function se(e){let t,n;function o(...r){return e[11](e[17],...r)}return t=new x({props:{options:$(e[15].value)?[]:e[15].value,onChange:o}}),{c(){R(t.$$.fragment)},m(r,d){q(t,r,d),n=!0},p(r,d){e=r;const f={};d&2&&(f.options=$(e[15].value)?[]:e[15].value),t.$set(f)},i(r){if(n)return;b(t.$$.fragment,r),n=!0},o(r){C(t.$$.fragment,r),n=!1},d(r){T(t,r)}}}function ie(e){let t;return{c(){t=P("Failed to load, please try re-opening this dialog.")},m(n,o){U(n,t,o)},p:S,i:S,o:S,d(n){n&&I(t)}}}function ue(e){let t;return{c(){t=N("div"),B(t,"class","loader")},m(n,o){U(n,t,o)},p:S,i:S,o:S,d(n){n&&I(t)}}}function fe(e){let t,n;function o(...r){return e[10](e[15],e[16],e[17],...r)}return t=new E({props:{field:{helperText:'See <a href="test" target="_blank">Remote Option Set Guide</a> for information on how to structure your endpoint response.',onChange:o,id:`${e[15].name}-url`,type:"string",value:e[15].value,name:"url",label:"Url",required:!0}}}),{c(){R(t.$$.fragment)},m(r,d){q(t,r,d),n=!0},p(r,d){e=r;const f={};d&2&&(f.field={helperText:'See <a href="test" target="_blank">Remote Option Set Guide</a> for information on how to structure your endpoint response.',onChange:o,id:`${e[15].name}-url`,type:"string",value:e[15].value,name:"url",label:"Url",required:!0}),t.$set(f)},i(r){if(n)return;b(t.$$.fragment,r),n=!0},o(r){C(t.$$.fragment,r),n=!1},d(r){T(t,r)}}}function K(e){let t,n,o=(e[15].name??"")+"",r,d,f,g,y,_,v,s,h,u,m;function c(...l){return e[8](e[15],e[16],e[17],...l)}g=new E({props:{field:{id:`${e[15].id}-name`,type:"string",required:!0,name:"name",label:"Name",placeholder:"Name",value:e[15].name,onChange:c}}});function O(...l){return e[9](e[15],e[16],e[17],...l)}_=new E({props:{field:{onChange:O,id:`${e[15].id}-type`,type:"combobox",value:e[15].type,options:{type:"local",value:[{label:"Inline",value:"local"},{label:"Remote",value:"remote"}]},name:"type",label:"Type",helperText:"Choose whether you want to automatically load options in from a remote url or manually specify them here."}}});const A=[fe,ue,ie,se],a=[];function i(l,p){return l[15].type==="remote"?0:l[2]?1:l[3]?2:3}return s=i(e,-1),h=a[s]=A[s](e),{c(){t=N("div"),n=N("h2"),r=P(o),d=M(),f=N("div"),R(g.$$.fragment),y=M(),R(_.$$.fragment),v=M(),h.c(),B(f,"id",u=e[15].name??""),D(t,"margin-top","1em")},m(l,p){U(l,t,p),k(t,n),k(n,r),k(t,d),k(t,f),q(g,f,null),k(f,y),q(_,f,null),k(f,v),a[s].m(f,null),m=!0},p(l,p){e=l,(!m||p&2)&&o!==(o=(e[15].name??"")+"")&&Y(r,o);const w={};p&2&&(w.field={id:`${e[15].id}-name`,type:"string",required:!0,name:"name",label:"Name",placeholder:"Name",value:e[15].name,onChange:c}),g.$set(w);const j={};p&3&&(j.field={onChange:O,id:`${e[15].id}-type`,type:"combobox",value:e[15].type,options:{type:"local",value:[{label:"Inline",value:"local"},{label:"Remote",value:"remote"}]},name:"type",label:"Type",helperText:"Choose whether you want to automatically load options in from a remote url or manually specify them here."}),_.$set(j);let L=s;s=i(e,p),s===L?a[s].p(e,p):(G(),C(a[L],1,1,()=>{a[L]=null}),F(),h=a[s],h||(h=a[s]=A[s](e),h.c()),b(h,1),h.m(f,null)),(!m||p&2&&u!==(u=e[15].name??""))&&B(f,"id",u)},i(l){if(m)return;b(g.$$.fragment,l),b(_.$$.fragment,l),b(h),m=!0},o(l){C(g.$$.fragment,l),C(_.$$.fragment,l),C(h),m=!1},d(l){l&&I(t),T(g),T(_),a[s].d()}}}function ce(e){let t,n,o,r,d,f;function g(u,m){return u[1].length>0?ae:re}let y=g(e,-1),_=y(e),v=e[1],s=[];for(let u=0;u<v.length;u+=1)s[u]=K(J(e,v,u));const h=u=>C(s[u],1,1,()=>{s[u]=null});return d=new te({props:{label:"Save",processingLabel:"Saving...",actions:[{label:"Save as Draft",onClick:e[6]},{label:"Save and Publish",onClick:e[6]}]}}),{c(){t=N("div"),_.c(),n=M();for(let u=0;u<s.length;u+=1)s[u].c();o=M(),r=N("div"),R(d.$$.fragment),B(r,"class","float-right")},m(u,m){U(u,t,m),_.m(t,null),k(t,n);for(let c=0;c<s.length;c+=1)s[c].m(t,null);k(t,o),k(t,r),q(d,r,null),f=!0},p(u,[m]){if(y!==(y=g(u,m))&&(_.d(1),_=y(u),_&&(_.c(),_.m(t,n))),m&63){v=u[1];let c;for(c=0;c<v.length;c+=1){const O=J(u,v,c);s[c]?(s[c].p(O,m),b(s[c],1)):(s[c]=K(O),s[c].c(),b(s[c],1),s[c].m(t,o))}for(G(),c=v.length;c<s.length;c+=1)h(c);F()}},i(u){if(f)return;for(let m=0;m<v.length;m+=1)b(s[m]);b(d.$$.fragment,u),f=!0},o(u){s=s.filter(Boolean);for(let m=0;m<s.length;m+=1)C(s[m]);C(d.$$.fragment,u),f=!1},d(u){u&&I(t),_.d(),V(s,u),T(d)}}}function me(e,t,n){let o=[],r=!1,d=!1,{name:f}=t,{isNew:g}=t;Z(async()=>{g?n(1,o=o.concat([{value:[{label:"",value:""}],type:"local"}])):await y()});async function y(){n(2,r=!0);const a=await oe("option-set"),i=a.find(l=>l.name===f);if(!i)return;i.type==="local"&&(i.localSaveId=i.value,i.value=await v(i)),n(1,o=[i]),n(2,r=!1)}async function _(a){n(1,o[a].value=await v(o[a]),o)}async function v(a){n(2,r=!0);try{const i=a.value??a.localSaveId;if(!i)return[{label:"",value:""}];const l=await fetch(i),p=await l.json(),w=[];return Object.keys(p).forEach(j=>{w.push({label:j,value:p[j]})}),w}catch(i){return n(3,d=!0),[]}finally{n(2,r=!1)}}function s(a,i){n(1,o[i].value=a,o)}async function h(){const a=o.map(async l=>(l.type==="local"&&(l.value=await u(l)),l)),i=await Promise.all(a);await z("option-set",i[0]),H("option_set_modified",i[0]),H("dialog_show",{child:ne,closeOnOutsideClick:!1,confirmCloseOnDirty:!0,title:"Manage Option Sets"})}async function u(a){const i={},l=a.value;l.forEach(L=>{i[L.label]=L.value});const p=ee("id",a.localSaveId),w=p?`?id=${p}`:"",{message:j}=w?await le(`s3/json?${w}`,i):await z(`s3/json?${w}`,i);return j}const m=(a,i,l,p)=>{n(1,i[l].name=p,o)},c=(a,i,l,p)=>{p==="local"&&(n(1,i[l].remoteUrl=a.value,o),n(1,i[l].value=a.localOptions,o),!g&&a.localOptions?.length===0&&(n(1,i[l].value=void 0,o),_(l))),p==="remote"&&(n(1,i[l].localOptions=a.value??[],o),n(1,i[l].value=a.remoteUrl,o)),n(1,i[l].type=p,o)},O=(a,i,l,p)=>{n(1,i[l].value=p,o)},A=(a,i)=>{s(i,a)};return e.$$set=a=>{"name"in a&&n(7,f=a.name),"isNew"in a&&n(0,g=a.isNew)},[g,o,r,d,_,s,h,f,m,c,O,A]}class pe extends Q{constructor(e){super();W(this,e,me,ce,X,{name:7,isNew:0})}}export default pe;

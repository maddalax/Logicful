import{SvelteComponent as q,append as L,attr as G,check_outros as T,create_component as P,destroy_component as C,detach as k,element as F,group_outros as B,init as V,insert as w,mount_component as D,noop as A,safe_not_equal as Y,space as z,transition_in as b,transition_out as v}from"../../../../web_modules/svelte/internal.js";import{randomStringSmall as S,randomString as H}from"../../../util/Generate.js";import{onMount as I,tick as M}from"../../../../web_modules/svelte.js";import{subscribeFieldChange as E}from"../../../event/FieldEvent.js";import N from"./DynamicForm.js";import h from"../../../store/FormStore.js";import"../../../util/Selection.js";import{fastClone as x}from"../../../util/Compare.js";import{saveForm as J,saveToLocalStorage as K}from"./services/SaveForm.js";import O from"../../../components/ToastManager.js";import"../../../util/Debounce.js";import{setFieldDefaults as U}from"./services/DefaultFieldValueFactory.js";import{getApi as Q}from"../../../services/ApiService.js";import{getUrlParameter as R}from"../../../util/Http.js";import{startPreviewSaver as X}from"./services/PreviewSaver.js";import{DynamicFormMode as W}from"../../../components/models/ComponentProps.js";import{dispatch as j,subscribeComponent as g}from"../../../event/EventBus.js";import{navigate as Z}from"../../../../web_modules/svelte-routing.js";function $(m){let i,r,o,t,s;const a=[te,re],e=[];function u(c,f){return c[1]?0:1}return o=u(m,-1),t=e[o]=a[o](m),{c(){i=F("div"),r=F("div"),t.c()},m(c,f){w(c,i,f),L(i,r),e[o].m(r,null),s=!0},p(c,f){let _=o;o=u(c,f),o===_?e[o].p(c,f):(B(),v(e[_],1,1,()=>{e[_]=null}),T(),t=e[o],t||(t=e[o]=a[o](c),t.c()),b(t,1),t.m(r,null))},i(c){if(s)return;b(t),s=!0},o(c){v(t),s=!1},d(c){c&&k(i),e[o].d()}}}function ee(m){let i;return{c(){i=F("div"),i.innerHTML='<div class="d-flex justify-content-center"><div class="spinner-border" style="width: 3rem; height: 3rem; margin-top: 2em" role="status"><span class="sr-only">Loading...</span></div></div>',G(i,"class","flex-column justify-content-center align-items-center")},m(r,o){w(r,i,o)},p:A,i:A,o:A,d(r){r&&k(i)}}}function re(m){let i,r,o;return r=new N({props:{form:m[2],mode:W.Preview}}),{c(){i=F("div"),P(r.$$.fragment)},m(t,s){w(t,i,s),D(r,i,null),o=!0},p(t,s){const a={};s&4&&(a.form=t[2]),r.$set(a)},i(t){if(o)return;b(r.$$.fragment,t),o=!0},o(t){v(r.$$.fragment,t),o=!1},d(t){t&&k(i),C(r)}}}function te(m){let i,r,o;return r=new N({props:{form:m[1],mode:W.Preview}}),{c(){i=F("div"),P(r.$$.fragment)},m(t,s){w(t,i,s),D(r,i,null),o=!0},p(t,s){const a={};s&2&&(a.form=t[1]),r.$set(a)},i(t){if(o)return;b(r.$$.fragment,t),o=!0},o(t){v(r.$$.fragment,t),o=!1},d(t){t&&k(i),C(r)}}}function le(m){let i,r,o,t,s,a;r=new O({});const e=[ee,$],u=[];function c(f,_){return f[2]==null||f[0]?0:1}return t=c(m,-1),s=u[t]=e[t](m),{c(){i=F("div"),P(r.$$.fragment),o=z(),s.c()},m(f,_){w(f,i,_),D(r,i,null),L(i,o),u[t].m(i,null),a=!0},p(f,[_]){let l=t;t=c(f,_),t===l?u[t].p(f,_):(B(),v(u[l],1,1,()=>{u[l]=null}),T(),s=u[t],s||(s=u[t]=e[t](f),s.c()),b(s,1),s.m(i,null))},i(f){if(a)return;b(r.$$.fragment,f),b(s),a=!0},o(f){v(r.$$.fragment,f),v(s),a=!1},d(f){f&&k(i),C(r),u[t].d()}}}let De=!1,Ae=0;function oe(m,i,r){let o=!1,t=[],s,a=!1,e;async function u(){r(0,o=!0);const l=R("formId");if(!l){Z("/form/create",{replace:!0});return}try{if(await c(l),!e)return;e.fields||r(2,e.fields=[],e),r(2,e.fields=e.fields.map(n=>(n.selected=!1,n)),e),r(2,e.loaded=!0,e),h.setForm(e),j("form_loaded",{form:e}),K(e),X()}finally{r(0,o=!1)}}async function c(l){if(!l)return;r(2,e=await Q(`form/${l}`))}function f(){const l=e.fields.findIndex(n=>n.type==="placeholder");if(l!==-1){const n=x(e.fields);n.splice(l,1),r(2,e.fields=n,e),j("form_placeholder_changed",{added:!1})}}function _(){if(e.fields.filter(l=>l.type!=="placeholder").length!==0){f();return}if(e.fields.find(l=>l.type==="placeholder"))return;r(2,e.fields=e.fields.concat([{name:"placeholder-field",label:"You have no fields",type:"placeholder",id:"placeholder"}]),e),j("form_placeholder_changed",{added:!0})}return g("form_updated",l=>{r(2,e=l),_(),a=!0}),g("field_delete",l=>{const n=e.fields.findIndex(p=>p.id===l.field.id),d=[...e.fields];d.splice(n,1),r(2,e.fields=d,e),h.setForm(e)}),g("right_sidebar_loaded",()=>{e&&j("form_loaded",{form:e})}),g("add_field",l=>{r(2,e.fields=e.fields.map(p=>(p.selected=!1,p)),e);const n=H();let d={name:"new-field-"+S(),label:"New Field "+S(),type:l.type,id:n,selected:!0,value:void 0,expanded:!0};d=U(d),r(2,e.fields=e.fields.concat(d),e),f(),h.setForm(e)}),g("field_clone",l=>{const n=e.fields.findIndex(y=>y.id===l.field.id),d=x(e.fields[n]);d.name=d.name+"-"+S(),d.label=d.label+" Copy",d.id=H(),d.selected=!0;const p=x(e.fields);p.splice(n+1,0,d),r(2,e.fields=p,e),h.set(d)}),g("save_form",async l=>{await J()}),g("get_form_fields",()=>e.fields),g("drag_over",()=>{f()}),g("drag_finished",async l=>{f();let n=l.filter(d=>d).map(d=>{if(d.id==="form-field-placeholder")return;if(d.id.startsWith("form-field-")){const p=e.fields.find(y=>y.id===d.id.replace("form-field-",""));return p&&(p.selected=!1),p}if(d.id.startsWith("sidebar-block-")){const p=d.id.replace("sidebar-block-","");let y={id:H(),type:p,name:"new-field-"+S(),label:"New Field "+S(),selected:!0,value:void 0};return y=U(y),y}});n=n.filter(d=>d!=null),r(2,e.fields=x(n),e),await j("destroy_dragula",{}),await M(),r(1,s=x(e)),h.setForm(e),await M(),r(1,s=void 0),e.fields.length===0&&_(),await M(),j("reload_dragula",{})}),E(I,l=>{if(!l.selected)return;r(2,e.fields=e.fields.map(n=>(n.id!==l.id&&n.selected&&(n.selected=!1,h.set(n)),n)),e)}),g("form_saved",l=>{a=!1}),g("form_updated",l=>{r(2,e=l)}),g("unselect_field",()=>{r(2,e.fields=e.fields.map(l=>(l.selected&&(l.selected=!1,h.set(l)),l)),e)}),E(I,async l=>{if(!e||!e.fields)return;a=!0;const n=e.fields.findIndex(d=>d.id===l.id);n!==-1&&r(2,e.fields[n]=l,e)}),I(async()=>{u()}),[o,s,e]}class ie extends q{constructor(m){super();V(this,m,oe,le,Y,{})}}export default ie;

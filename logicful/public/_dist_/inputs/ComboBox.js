import"./ComboBox.css.proxy.js";import{SvelteComponent as le,add_flush_callback as ne,append as I,attr as z,bind as ie,binding_callbacks as se,bubble as re,check_outros as D,create_component as A,destroy_component as G,detach as k,element as S,empty as fe,group_outros as M,init as ue,insert as w,listen as ae,mount_component as N,noop as T,safe_not_equal as ce,set_style as pe,space as K,stop_propagation as de,transition_in as _,transition_out as g}from"../../web_modules/svelte/internal.js";import{onDestroy as me,onMount as P}from"../../web_modules/svelte.js";import{LoadState as j}from"../models/LoadState.js";import{stringEquals as q,fastEquals as _e}from"../util/Compare.js";import{subscribeFieldChange as be}from"../event/FieldEvent.js";import{isFunction as ve,isString as J}from"../guards/Guard.js";import{randomString as ge}from"../util/Generate.js";import{dispatch as he,subscribeComponent as F}from"../event/EventBus.js";import Q from"../../web_modules/fusejs.js";import E from"../store/FormStore.js";import"../util/Compare.js";import ke from"./Label.js";import we from"../components/select/Select.js";function R(f){let l,e;return l=new ke({props:{field:f[0]}}),{c(){A(l.$$.fragment)},m(s,n){N(l,s,n),e=!0},p(s,n){const r={};n&1&&(r.field=s[0]),l.$set(r)},i(s){if(e)return;_(l.$$.fragment,s),e=!0},o(s){g(l.$$.fragment,s),e=!1},d(s){G(l,s)}}}function Se(f){let l,e,s,n=f[3]&&W(f),r=f[0].helperText&&X(f);return{c(){n&&n.c(),l=K(),r&&r.c(),e=fe()},m(i,t){n&&n.m(i,t),w(i,l,t),r&&r.m(i,t),w(i,e,t),s=!0},p(i,t){i[3]?n?(n.p(i,t),t&8&&_(n,1)):(n=W(i),n.c(),_(n,1),n.m(l.parentNode,l)):n&&(M(),g(n,1,1,()=>{n=null}),D()),i[0].helperText?r?r.p(i,t):(r=X(i),r.c(),r.m(e.parentNode,e)):r&&(r.d(1),r=null)},i(i){if(s)return;_(n),s=!0},o(i){g(n),s=!1},d(i){n&&n.d(i),i&&k(l),r&&r.d(i),i&&k(e)}}}function Te(f){let l;return{c(){l=S("p"),l.textContent="Failed to load."},m(e,s){w(e,l,s)},p:T,i:T,o:T,d(e){e&&k(l)}}}function je(f){let l;return{c(){l=S("div"),l.innerHTML='<div class="spinner-border" role="status"><span class="sr-only">Loading...</span></div>'},m(e,s){w(e,l,s)},p:T,i:T,o:T,d(e){e&&k(l)}}}function W(f){let l,e,s,n,r,i;function t(a){f[8].call(null,a)}let d={inputAttributes:{autocomplete:"off"},items:f[3],isVirtualList:f[3].length>25,itemFilter:f[4],showChevron:!0};return f[2]!==void 0&&(d.selectedValue=f[2]),e=new we({props:d}),se.push(()=>ie(e,"selectedValue",t)),e.$on("select",f[5]),e.$on("clear",f[6]),{c(){l=S("div"),A(e.$$.fragment),z(l,"class","themed svelte-3dptv7")},m(a,u){w(a,l,u),N(e,l,null),n=!0,r||(i=ae(l,"click",de(f[7])),r=!0)},p(a,u){const c={};u&8&&(c.items=a[3]),u&8&&(c.isVirtualList=a[3].length>25),!s&&u&4&&(s=!0,c.selectedValue=a[2],ne(()=>s=!1)),e.$set(c)},i(a){if(n)return;_(e.$$.fragment,a),n=!0},o(a){g(e.$$.fragment,a),n=!1},d(a){a&&k(l),G(e),r=!1,i()}}}function X(f){let l,e,s=(f[0].helperText??"")+"";return{c(){l=S("div"),e=S("small"),z(e,"class","form-text text-muted"),pe(l,"padding-top","0.3em")},m(n,r){w(n,l,r),I(l,e),e.innerHTML=s},p(n,r){r&1&&s!==(s=(n[0].helperText??"")+"")&&(e.innerHTML=s)},d(n){n&&k(l)}}}function Le(f){let l,e,s,n,r,i=!f[0].hideLabel&&R(f);const t=[je,Te,Se],d=[];function a(u,c){return u[1]===j.Loading?0:u[1]===j.Failed?1:2}return s=a(f,-1),n=d[s]=t[s](f),{c(){l=S("div"),i&&i.c(),e=K(),n.c()},m(u,c){w(u,l,c),i&&i.m(l,null),I(l,e),d[s].m(l,null),r=!0},p(u,[c]){u[0].hideLabel?i&&(M(),g(i,1,1,()=>{i=null}),D()):i?(i.p(u,c),c&1&&_(i,1)):(i=R(u),i.c(),_(i,1),i.m(l,e));let b=s;s=a(u,c),s===b?d[s].p(u,c):(M(),g(d[b],1,1,()=>{d[b]=null}),D(),n=d[s],n||(n=d[s]=t[s](u),n.c()),_(n,1),n.m(l,null))},i(u){if(r)return;_(i),_(n),r=!0},o(u){g(i),g(n),r=!1},d(u){u&&k(l),i&&i.d(),d[s].d()}}}function ye(f,l,e){let s=!1,n,r=!1,i,{field:t}=l,d=null,a;me(()=>{B()}),F("show_field_config",o=>{h="",e(3,m=[]),c()}),F("combobox_get_options",o=>{if(o.id===t.id)return m}),F("combobox_open",o=>{o.id!==t.id&&C()}),F("option_set_modified",o=>{o.value===t.options&&c(),t.configTarget&&c()}),be(P,o=>{o.id===t.id&&(h=o.value??"",O())}),P(async()=>{n=`${t.name}-${ge()}`,s=!1,h=E.getValue(t.id),await c()});function u(){return m?new Q(m,{keys:["label","value"]}):new Q([])}async function c(){e(1,b=j.Loading),e(3,m=[]);try{if(t.options?.type==="remote"||J(t.options)||t.options?.type==="local"&&J(t.options.value)){const o=t.options.value||t.options,p=await fetch(o),v=await p.json();if(!v)return;const U=[];t.loadTransformer?e(3,m=t.loadTransformer(v)??[]):(Object.keys(v).forEach(H=>{U.push({value:v[H],label:H})}),e(3,m=U??[]))}else{const o=t.options?.value,p=ve(o)?await o():await o;e(3,m=(t.loadTransformer?t.loadTransformer(p):p)??[])}i=u(),O(),e(1,b=j.Finished)}catch(o){console.log(o),e(3,m=[]),e(1,b=j.Failed)}}let b=j.Loading,h="",y,m=[],V="",L=new Set;function O(){const o=m?.find(p=>q(p.label,h)||q(p.value,h));o&&(h=o.label??"",e(2,y=o))}function Ce(o){C(),h=o.value,e(0,t.value=o.value,t),E.set(t,{field:"value",value:o.value,fromUser:!0}),t.onChange?.(t.value)}function Fe(){C()}function Y(o){if(m.length===0)L=new Set;else if(o==null||o==="")L=new Set;else{const p=i.search(o);V="",L=new Set(p.map(v=>v.item.value)),V=o}}function Ee(o){if(o.key==="Escape")C();else if(o.key==="ArrowDown"){o.preventDefault();const p=document.getElementById(`${t.id}-option-0`);p?.focus({preventScroll:!0})}}function Be(){he("combobox_open",{id:t.id}),r=!0}function C(){B(),r=!1,L.clear(),V=""}function B(){if(a)try{a.dispose()}catch(o){}a=void 0}function Z(o,p){a=new bootstrap.Tooltip(document.getElementById(p),{title:o.label,placement:"top",trigger:"manual"}),setTimeout(()=>{a.show()},600)}function x(o,p,v){return V!=p&&Y(p),L.has(v.value)}function $(o){o.stopPropagation(),e(0,t.value=o.detail.value,t),E.set(t,{field:"value",value:t.value,fromUser:!0})}function ee(){e(0,t.value=void 0,t),E.set(t,{field:"value",value:void 0,fromUser:!0})}function De(o,p){B(),Z(o,p)}function te(o){re(f,o)}function oe(o){y=o,e(2,y)}return f.$$set=o=>{"field"in o&&e(0,t=o.field)},f.$$.update=()=>{if(f.$$.dirty&8193){e:_e(d,t.options)||(e(13,d=t.options??[]),c())}},[t,b,y,m,x,$,ee,te,oe]}class Ve extends le{constructor(f){super();ue(this,f,ye,Le,ce,{field:0})}}export default Ve;
